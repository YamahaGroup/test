const cds = require('../../../')

module.exports = srv => (req, _, next) => {
  // if not a GET, use req.path instead of req.url to ignore query parameters
  req._query = cds.odata.parse(req.method === 'GET' ? req.url : req.path, { service: srv, baseUrl: req.baseUrl })

  const preferReturn = req.headers.prefer?.match(/\W?return=(\w+)/i)
  if (preferReturn) req._preferReturn = preferReturn[1]

  next()
}
